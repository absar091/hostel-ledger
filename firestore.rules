rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and write their own user document only
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId && 
                   resource == null && 
                   request.resource.data.keys().hasAll(['uid', 'email', 'name', 'createdAt']) &&
                   request.resource.data.uid == request.auth.uid;
    }
    
    // Groups - only members can access
    match /groups/{groupId} {
      allow read: if request.auth != null && 
                 (resource.data.createdBy == request.auth.uid ||
                  exists(/databases/$(database)/documents/userGroups/$(request.auth.uid)/$(groupId)));
      allow write: if request.auth != null && 
                  (resource.data.createdBy == request.auth.uid ||
                   exists(/databases/$(database)/documents/userGroups/$(request.auth.uid)/$(groupId)));
      allow create: if request.auth != null && 
                   request.resource.data.createdBy == request.auth.uid &&
                   request.resource.data.keys().hasAll(['name', 'emoji', 'members', 'createdBy', 'createdAt']);
    }
    
    // User groups - users can only access their own groups
    match /userGroups/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Transactions - only accessible by group members
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null && 
                        exists(/databases/$(database)/documents/userTransactions/$(request.auth.uid)/$(transactionId));
      allow create: if request.auth != null && 
                   request.resource.data.keys().hasAll(['groupId', 'type', 'amount', 'createdAt']) &&
                   request.resource.data.amount is number &&
                   request.resource.data.amount > 0;
    }
    
    // User transactions - users can only access their own transactions
    match /userTransactions/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Verification codes - restricted access for signup only
    match /verificationCodes/{codeId} {
      allow read, write: if request.auth == null;
      allow delete: if request.auth == null;
    }
    
    // Email verification - restricted access
    match /emailVerification/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth == null; // Allow unauthenticated read for verification
    }
  }
}